---
title: 共立製薬-スコアシート自動化設計案
tags: [project/kyoritsu, design, automation, ocr, form-recognition]
created: 2025-01-13
status: draft
---

# スコアシート自動化設計案：紙→PDF→Excel自動化システム

## 📋 概要

監視員が巡回時に紙のスコアシート（Excel印刷版）に記入し、それをPDF化してExcelに自動出力する業務フローの**半自動化**を実現するシステム設計案。

**重要**: 完全自動化ではなく、**OCR + 構造学習 + 信頼度判定 + 人手確認**を前提とした半自動化システム。

## 🎯 目的

- **転記作業の効率化**: 紙からExcelへの手入力転記作業を削減（完全自動化は目標としない）
- **既存ワークフローの維持**: 現場の紙ベースの記録方法を変更せずに自動化
- **データ精度の保証**: 誤転記の混入を防止し、研究資料として利用可能な品質を確保
- **確認工数の予測可能化**: confidence（信頼度）を活用した効率的な人手確認フロー

---

## 🔄 現状の業務フロー (As-Is)

```
1. 巡回・観察
   ↓
2. 紙のスコアシートに手書き記入
   （Excelを印刷したフォーマット）
   ↓
3. スコアシートをPDF化
   （スキャン or スマホ撮影）
   ↓
4. PDFからExcelへ手入力で転記 ⚠️ 課題
   （二重入力、転記ミス、タイムラグ）
   ↓
5. ExcelファイルをDropboxへ保存
```

### 課題点
- **転記作業の工数**: 紙→Excelへの手入力に時間がかかる
- **転記ミス**: 人間による転記作業での入力エラー
- **タイムラグ**: 記入からデータ化まで時間がかかる
- **データの散逸**: Dropbox上のExcelファイルによるデータ管理の難しさ

---

## 💡 提案する半自動化フロー (To-Be)

```
1. 巡回・観察
   ↓
2. 紙のスコアシートに手書き記入
   （既存のワークフロー維持）
   ↓
3. スコアシートをPDF化
   （スキャン：300dpi以上、傾き補正あり）
   ↓
4. PDFを自動処理システムへアップロード
   （Webアプリ or メール送信 or フォルダ監視）
   ↓
5. Document AI Custom Extractorによるデータ抽出
   - 位置（レイアウト）＝意味 を学習
   - 手書き文字認識（数字・日本語）
   - 表形式（Excel帳票）の構造復元
   ↓
6. OCR結果（JSON）取得 + 信頼度（confidence）判定
   ├─ 高信頼（閾値以上） → 自動確定
   └─ 低信頼（閾値未満） → 人手確認フラグ
   ↓
7. 中間データ保存（JSON / Google Sheets）
   - OCR結果を構造化データとして保存
   - confidence情報も保持
   ↓
8. 人手確認・補正（低信頼項目のみ）
   - confidenceが閾値未満の項目のみ確認
   - 全件目視確認は行わない
   ↓
9. 確定データをExcelへ転記 ✅ 自動化
   （既存フォーマットに準拠）
   ↓
10. Dropbox/クラウドDBへ自動保存 ✅ 自動化
```

### 重要な設計方針

- **完全自動化は目標としない**: OCRのみでExcelを自動生成することは目標としない
- **confidenceを必ず使用**: Document AIの信頼度スコアを活用した効率的な確認フロー
- **中間データを経由**: OCR結果を直接本番Excelに書き込まず、必ず中間データ（JSON/Sheets）を経由

---

## 🏗️ システムアーキテクチャ設計

### 全体構成

```
┌─────────────────────────────────────────────────┐
│  入力層（Input Layer）                           │
├─────────────────────────────────────────────────┤
│  - PDFアップロード（Web UI）                    │
│  - メール送信（PDF添付）                         │
│  - フォルダ監視（共有フォルダ）                  │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  処理層（Processing Layer）                       │
├─────────────────────────────────────────────────┤
│  1. PDF前処理                                    │
│     - 画像補正（傾き補正、コントラスト調整）     │
│     - フォーマット検証                           │
│                                                  │
│  2. AI/OCR処理                                   │
│     - Google Document AI（カスタムプロセッサ）  │
│     - テーブル構造認識                           │
│     - 手書き文字認識                             │
│     - チェックボックス検出                       │
│                                                  │
│  3. データ抽出・構造化                           │
│     - スコアシート項目のマッピング              │
│     - データ型変換（数値、日付、選択肢）         │
│     - バリデーション                              │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  検証層（Validation Layer）                      │
├─────────────────────────────────────────────────┤
│  - データ整合性チェック                          │
│  - 異常値検出                                    │
│  - 信頼度スコア算出                              │
│  - 要確認項目のフラグ付け                        │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  出力層（Output Layer）                          │
├─────────────────────────────────────────────────┤
│  - Excelファイル生成（既存フォーマット準拠）    │
│  - Dropbox/クラウドDBへの自動保存               │
│  - 処理結果通知（メール/Slack）                 │
│  - エラーログ・処理履歴                         │
└─────────────────────────────────────────────────┘
```

---

## 🔧 技術スタック（確定）

### 1. OCR・フォーム認識エンジン

#### Google Cloud Document AI - Custom Extractor（採用）
- **特徴**:
  - **Custom Extractor**を使用（位置（レイアウト）＝意味を学習）
  - 手書き文字認識対応（数字・日本語）
  - 表形式（Excel帳票）の構造復元が可能
  - **confidence（信頼度）スコア**を提供
- **費用**: 従量課金（1,000ページあたり約$1.50）
- **精度**: カスタムプロセッサ使用時、高精度
- **GCP統合**: GCP環境との統合が容易
- **学習データ要件**: 同一レイアウトにつき30〜50件以上（実際に手書きされたPDF）

#### 候補B: Azure Form Recognizer
- **特徴**: 
  - カスタムモデル学習可能
  - テーブル認識に強い
  - 手書き文字認識対応
- **費用**: 従量課金（1,000ページあたり約$1.50）
- **精度**: 高精度

#### 候補C: AWS Textract
- **特徴**:
  - テーブル・フォーム認識
  - 手書き文字認識対応
- **費用**: 従量課金
- **精度**: 高精度

### 2. データ処理・ワークフロー

#### 候補A: Cloud Run + Cloud Functions（採用）
- **特徴**: サーバーレス、スケーラブル、コンテナベース
- **メリット**: 低コスト、自動スケーリング、GCP統合

#### 候補B: n8n / Make（旧Integromat）
- **特徴**: ノーコード/ローコードワークフロー
- **メリット**: 開発速度、保守性

#### 候補C: Python + FastAPI
- **特徴**: カスタム開発
- **メリット**: 柔軟性、カスタマイズ性

### 3. データ保存・管理

#### 候補A: Dropbox API連携（既存環境維持）
- **特徴**: 既存のDropbox環境を活用
- **メリット**: 導入障壁低

#### 候補B: kintone / SharePoint
- **特徴**: 構造化データベース
- **メリット**: 検索・分析機能強化

#### 候補C: Google Cloud Storage + Cloud SQL（採用）
- **特徴**: クラウドネイティブ、GCP統合
- **メリット**: スケーラビリティ、分析機能、GCPサービスとの連携

---

## 📊 スコアシート項目の自動抽出設計

### 基本情報項目（テキスト認識）

| 項目 | 認識方法 | 検証ルール |
|------|---------|-----------|
| 年月日 | OCR + 日付パターン認識 | YYYY-MM-DD形式検証 |
| 時間 | OCR + 時刻パターン認識 | HH:MM形式検証 |
| 管理者 | OCR + 名前リスト照合 | 既存管理者リストと照合 |

### 数値入力項目（数値認識）

| 項目 | 認識方法 | 検証ルール |
|------|---------|-----------|
| 直腸温[℃] | OCR + 数値抽出 | 35.0-42.0℃の範囲チェック |
| 体重[kg] | OCR + 数値抽出 | 正の数値チェック |

### 選択式項目（チェックボックス検出）

| 項目 | 認識方法 | 検証ルール |
|------|---------|-----------|
| 食欲 | チェックボックス位置検出 | 選択肢リストと照合 |
| 元気 | チェックボックス位置検出 | 選択肢リストと照合 |
| 脱水 | チェックボックス位置検出 | 選択肢リストと照合 |
| 嘔吐 | チェックボックス位置検出 | 選択肢リストと照合 |
| 糞便 | チェックボックス位置検出 | 選択肢リストと照合 |
| 鼻汁 | チェックボックス位置検出 | 選択肢リストと照合 |
| 流淚 | チェックボックス位置検出 | 選択肢リストと照合 |
| 結膜炎 | チェックボックス位置検出 | 選択肢リストと照合 |
| 眼脂 | チェックボックス位置検出 | 選択肢リストと照合 |
| 発咳 | チェックボックス位置検出 | 選択肢リストと照合 |
| くしゃみ | チェックボックス位置検出 | 選択肢リストと照合 |
| 呼吸音異常 | チェックボックス位置検出 | 選択肢リストと照合 |

### チェックボックス検出のアプローチ

#### アプローチ1: 位置ベース検出（推奨）
- **方法**: スコアシートのテンプレート位置を定義
- **メリット**: 高精度、処理速度速い
- **要件**: スコアシートフォーマットの固定化

#### アプローチ2: AIベース検出
- **方法**: 機械学習モデルでチェックボックスを検出
- **メリット**: フォーマット変更に柔軟
- **要件**: 学習データの準備

---

## 🎨 UI/UX設計

### 入力方法の選択肢

#### 方法1: Webアプリケーション（推奨）
```
┌─────────────────────────────────┐
│  スコアシート自動化システム      │
├─────────────────────────────────┤
│                                  │
│  [PDFファイルを選択]              │
│  [アップロード]                  │
│                                  │
│  処理中...                       │
│                                  │
│  結果:                           │
│  ✓ データ抽出完了                │
│  ⚠ 要確認項目: 2件               │
│                                  │
│  [Excelダウンロード]             │
│  [Dropboxへ保存]                 │
└─────────────────────────────────┘
```

#### 方法2: メール送信
- PDFをメール添付で送信
- 自動処理後、結果をメール返信

#### 方法3: フォルダ監視
- 指定フォルダにPDFを配置
- 自動検出・処理・保存

### 確認・補正画面

```
┌─────────────────────────────────┐
│  データ確認・補正                │
├─────────────────────────────────┤
│  信頼度: 85%                     │
│                                  │
│  [基本情報]                      │
│  日付: 2025-01-13 ✓             │
│  時間: 14:30 ✓                  │
│  管理者: 田中太郎 ✓              │
│                                  │
│  [数値項目]                      │
│  直腸温: 38.5℃ ✓               │
│  体重: 12.3kg ✓                 │
│                                  │
│  [選択項目]                      │
│  食欲: 残餌1/3以下 ✓             │
│  元気: やや元気なし ⚠️           │
│     → [修正]                    │
│                                  │
│  [保存] [再処理]                 │
└─────────────────────────────────┘
```

---

## 📈 精度向上のための施策

### 1. スキャン品質の確保（必須要件）

#### 解像度・品質要件
- **解像度**: 300dpi以上
- **傾き補正**: 必須
- **影・裏写り**: 極力排除
- **記入用具**: 濃い黒のペン推奨、鉛筆は使用しない

#### 帳票（紙）設計上のルール
- **記入枠**: 十分な大きさを確保
- **数値記入**: 可能な限り数字のみで記入
- **自由記述欄**: 最小限に抑える
- **選択肢・チェックボックス**: 積極的に採用

> **重要**: 紙は維持するが、「自由な書き方」は前提としない

### 2. Custom Extractor学習設計

#### 学習データ要件
- **同一レイアウトにつき30〜50件以上**
- **実際に手書きされたPDFを使用**（空欄サンプルのみでの学習は禁止）
- 多様な記入パターンを含める

#### スキーマ設計
- **フィールド名は意味が明確なものとする**
  - 例: `sample_id`, `measurement_date`, `value_01`
- **曖昧・汎用的な名称は避ける**

### 3. 信頼度（confidence）を活用した人手確認フロー

#### 原則
- **Document AIのconfidenceを必ず使用**
- **confidenceが閾値未満の項目のみ人が確認**
- **全件目視確認は行わない**

#### 目的
- 誤転記の混入防止
- 確認工数の予測可能化

#### 想定フロー
1. OCR結果を構造化データ（JSON）として保存
2. confidence閾値で自動判定
   - 高信頼（閾値以上）→ 自動確定
   - 低信頼（閾値未満）→ 人手確認フラグ
3. 人手確認画面で低信頼項目のみ確認・補正
4. 確定データのみExcelへ転記

### 4. Excel転記方針

#### 基本ルール
- **OCR結果を直接本番Excelに書き込まない**
- **必ず中間データ（JSON / Google Sheets等）を経由**

#### 想定フロー
1. OCR結果を構造化データとして保存
2. 人手確認後に確定
3. 確定データのみExcelへ転記

### 5. バリデーションルール
- **目的**: 異常値・不整合の自動検出
- **例**:
  - 日付の整合性チェック
  - 数値範囲チェック（体温、体重）
  - 必須項目の記入漏れチェック
  - 過去データとの比較（異常値検出）

---

## 💰 費用試算

### 初期費用

| 項目 | 金額 | 備考 |
|------|------|------|
| システム開発 | 300-500万円 | 規模による |
| カスタムモデル学習 | 50-100万円 | サンプルデータ準備含む |
| テンプレートマッピング | 20-30万円 | スコアシートフォーマット定義 |
| 合計 | 370-630万円 | |

### 運用費用（月額）

| 項目 | 金額 | 備考 |
|------|------|------|
| OCR API費用 | 5-15万円 | 処理件数による（月100-300件想定） |
| サーバー・インフラ | 3-5万円 | Azure Functions等 |
| 保守・サポート | 10-20万円 | バグ修正・機能改善 |
| 合計 | 18-40万円/月 | |

### ROI試算

**現状の転記作業時間**: 1件あたり10分 × 月200件 = 33時間/月
**自動化後**: 確認作業のみ 1件あたり2分 × 月200件 = 6.7時間/月

**削減時間**: 26.3時間/月（約80%削減）
**人件費削減**: 26.3時間 × 時給3,000円 = 約8万円/月

**投資回収期間**: 約4-6年（初期費用を考慮）

---

## 🚀 実装フェーズ

### Phase 1: PoC（概念実証）- 1-2ヶ月
- **目的**: 技術的実現可能性の検証、Custom Extractorの精度検証
- **内容**:
  - サンプルPDF（30-50件、実際に手書きされたもの）の収集
  - Custom Extractorの学習・精度検証
  - confidence閾値の初期設定検討
  - 基本フローの実装（OCR → JSON → 確認画面）
- **成果物**: 精度レポート、confidence分析結果、デモシステム

### Phase 2: プロトタイプ開発 - 2-3ヶ月
- **目的**: 実運用に近いシステムの構築
- **内容**:
  - Webアプリケーション開発
  - **confidenceを活用した確認画面**実装（低信頼項目のみ表示）
  - 中間データ管理機能（JSON / Google Sheets）
  - Excel出力機能実装
  - Dropbox連携実装
- **成果物**: プロトタイプシステム

### Phase 3: 本番環境構築 - 1-2ヶ月
- **目的**: 実運用開始
- **内容**:
  - 本番環境セットアップ
  - confidence閾値の調整（運用データに基づく）
  - ユーザー教育・トレーニング（スキャン品質、帳票記入ルール含む）
  - 運用マニュアル作成
  - サポート体制構築
- **成果物**: 本番システム、運用マニュアル

## ✅ 成功判定基準

- ✅ **人手確認件数が全体の一部に限定されている**（例: 全体の20-30%以下）
- ✅ **誤転記が研究資料として問題にならない水準で抑制されている**
- ✅ **運用が属人化せず、再現可能である**
- ✅ **confidence閾値が適切に設定され、確認工数が予測可能**

---

## ⚠️ リスクと対策

### リスク1: OCR精度が低い（手書き文字・表構造）
- **影響**: データ抽出エラー、手動補正作業増加
- **対策**: 
  - Custom Extractorで位置（レイアウト）＝意味を学習
  - スキャン品質の確保（300dpi以上、傾き補正）
  - 帳票設計の改善（記入枠の大きさ、選択肢化）
  - confidenceを活用した効率的な人手確認フロー

### リスク2: スコアシートフォーマット変更
- **影響**: システム対応が必要
- **対策**:
  - Custom Extractorの再学習（30-50件の学習データ）
  - バージョン管理機能の実装
  - 変更時の迅速対応体制

### リスク3: 手書き文字の認識精度（特に日本語自由記述）
- **影響**: 文字が読み取れない
- **対策**:
  - 自由記述欄を最小限に抑える帳票設計
  - 記入時のガイドライン提供（読みやすい字で記入、濃いペン使用）
  - confidenceが低い項目は人手確認フローで対応
  - **前提**: 日本語自由記述の高精度OCRを前提にしない

### リスク4: confidence閾値の設定ミス
- **影響**: 誤転記の混入、または過剰な確認作業
- **対策**:
  - 初期閾値は保守的に設定（例: 90%以上）
  - 運用データで閾値を調整
  - 誤転記が発生した場合は閾値を引き上げ

### リスク5: システム障害
- **影響**: 業務停止
- **対策**:
  - 冗長化構成
  - バックアップシステム
  - 手動処理へのフォールバック手順

## 🚫 明確に「やらないこと」

- ❌ **完全自動化を目標にしない**: OCRのみでExcelを自動生成することは目標としない
- ❌ **日本語自由記述の高精度OCRを前提にしない**: 自由記述欄は最小限に抑える
- ❌ **confidence無視の自動転記をしない**: 必ずconfidenceを活用した確認フローを実装
- ❌ **帳票設計を変えずに精度改善を期待しない**: スキャン品質と帳票設計の改善は必須

---

## 📋 次のアクション

### クライアント側
- [ ] スコアシートのサンプルPDF提供（10-20件）
- [ ] 既存Excelフォーマットの提供
- [ ] 記入ルール・ガイドラインの確認
- [ ] 処理件数の確認（月間想定件数）

### NTT側
- [ ] 技術スタックの最終選定
- [ ] PoC計画の詳細化
- [ ] 費用見積の精緻化
- [ ] 実装スケジュールの確定

---

## 📎 参考資料

- [[20251203_共立製薬-動物監視AI導入要件整理]]
- [[2025-12-19-提案骨子]]
- [[実装計画-紙PDFExcel自動化]]
- Google Document AI: https://cloud.google.com/document-ai
- Google Cloud Platform: https://cloud.google.com/

---

**作成日**: 2025-01-13  
**作成者**: NTTDXPN  
**ステータス**: 設計検討中

