# 入札王メール → Slack自動通知

入札王から届くメール配信を自動パースし、Slackチャンネルに通知するGoogle Apps Scriptツール。

## 動作フロー

```
Gmail (入札王メール受信)
  ↓ 5分間隔トリガー
Google Apps Script
  ├─ メール検索（未処理のみ）
  ├─ 本文パース（案件名・機関・日付・方式等）
  ├─ Slack Webhook送信（Block Kit形式）
  └─ Gmailラベル付与（二重通知防止）
```

## セットアップ手順

### 1. Slack Incoming Webhook 作成（~3分）

1. [Slack API](https://api.slack.com/apps) にアクセス
2. **Create New App** → **From scratch** → アプリ名「入札王通知」、ワークスペースを選択
3. 左メニュー **Incoming Webhooks** → **Activate** をON
4. **Add New Webhook to Workspace** → 通知先チャンネル（例: `#入札案件通知`）を選択
5. 生成された **Webhook URL** をコピー（`https://hooks.slack.com/services/T.../B.../xxx`）

### 2. Google Apps Script プロジェクト作成（~2分）

1. [Google Apps Script](https://script.google.com/) にアクセス
2. **新しいプロジェクト** をクリック
3. プロジェクト名を「入札王Slack通知」に変更
4. デフォルトの `Code.gs` の中身を全選択して削除
5. `Code.gs`（本リポジトリ）の内容を全てコピペ

### 3. Webhook URL を設定（~1分）

1. GASエディタの左メニュー **⚙ プロジェクトの設定**
2. **スクリプト プロパティ** セクションで **スクリプト プロパティを追加**
3. プロパティ名: `SLACK_WEBHOOK_URL`、値: Step 1でコピーしたWebhook URL
4. **保存**

### 4. テスト実行（~2分）

1. GASエディタで関数セレクタから `testParseOnly` を選択 → **実行**
2. 初回はGmail権限の承認ダイアログが出るので許可
3. **実行ログ** でパース結果を確認
4. 問題なければ `testSendToSlack` を実行 → Slackに通知が届くことを確認

### 5. 自動トリガー設定（~1分）

1. 左メニュー **⏰ トリガー**
2. **トリガーを追加** をクリック
3. 設定:
   - 実行する関数: `main`
   - イベントのソース: **時間主導型**
   - 時間ベースのトリガーのタイプ: **分ベースのタイマー**
   - 間隔: **5分おき**
4. **保存**

## Slack通知フォーマット

各案件が以下の形式でSlackに投稿されます:

```
🔔 新着入札案件
━━━━━━━━━━━━━━━
📋 教育用生成AI文章添削システムの調達について
🏢 発注機関: 岐阜県
📍 地域: 岐阜県
📅 入札日: 2026/03/25
🔖 入札方式: 競争・公募
📂 カテゴリ: 情報処理機器・ソフト及び業務
[🔗 入札王で詳細を見る]  ← クリックで詳細ページへ
━━━━━━━━━━━━━━━
```

## 利用可能な関数

| 関数名 | 用途 |
|--------|------|
| `main` | メイン処理。トリガーから自動実行 |
| `testParseOnly` | パースのみ実行（Slack送信なし）。ログで確認 |
| `testSendToSlack` | 最新メールをパースしてSlackに送信（ラベルなし） |
| `resetLabels` | 処理済みラベルを全除去（再テスト用） |

## 注意事項

- **Gmail検索**: `newer_than:7d` で直近7日分のみ検索。初回実行時に過去メールが一括通知される可能性あり
- **レート制限**: 案件間で1秒の待機を入れてSlackのレート制限を回避
- **★マーク**: メール内で重複表示される案件（★付き）は自動スキップ
- **ラベル**: 「入札王/通知済」ラベルがGmailに自動作成される
